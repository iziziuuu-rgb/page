<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Diary & Finance - Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        :root {
            --point-pink: #fff5f6; --point-blue: #f0f7ff; --point-blue-text: #60a5fa;
            --point-purple: #f8f7ff; --point-yellow-muted: #fefaf0; --text-main: #4b5563;
            --border-color: #eeeeee; --hover-blue: #e0f2fe;
        }
        body { font-family: "Pretendard Variable", sans-serif; background-color: #ffffff; color: var(--text-main); -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        section { display: none; } section.active { display: block !important; }

        /* Ï∫òÎ¶∞Îçî Ïä§ÌÉÄÏùº */
        .calendar-grid { display: grid !important; grid-template-columns: repeat(7, 1fr) !important; border-top: 1.5px solid var(--border-color); border-left: 1.5px solid var(--border-color); background-color: #ffffff; position: relative; z-index: 1; }
        .calendar-cell { border-right: 1.5px solid var(--border-color); border-bottom: 1.5px solid var(--border-color); aspect-ratio: 1 / 1.4; padding: 8px; display: flex; flex-direction: column; background-color: #ffffff; position: relative; transition: background-color 0.2s; }
        .calendar-cell:hover { background-color: var(--hover-blue); }
        .cell-memo { width: 100%; flex-grow: 1; border: none; outline: none; resize: none; background: transparent; font-size: 10px; line-height: 1.4; padding: 0; margin-top: 4px; opacity: 0; transition: opacity 0.2s; color: #111827; font-weight: 500; }
        .calendar-cell:hover .cell-memo, .cell-memo:focus, .cell-memo:not(:placeholder-shown) { opacity: 1; }

        .nav-btn { color: #9ca3af; padding-bottom: 2px; transition: all 0.2s; border-bottom: 2px solid transparent; }
        .nav-btn.active { color: #111827; font-weight: 800; border-bottom: 2px solid #111827; }
        
        .diary-box { background-color: var(--point-yellow-muted); border-radius: 2.5rem; padding: 2.5rem; border: 1px solid #f9f3e5; display: flex; flex-direction: column; height: 100%; }
        .diary-paper { background-color: transparent; line-height: 1.8; border: none; outline: none; resize: none; width: 100%; flex-grow: 1; color: #111827; font-size: 0.875rem; }

        .archive-list-item { display: flex; gap: 20px; padding: 20px; border-radius: 2rem; background-color: #fdfdfd; border: 1px solid #f7f7f7; align-items: center; cursor: pointer; transition: all 0.2s; }
        .archive-list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.02); background-color: #ffffff; }

        .finance-item { display: flex; justify-content: space-between; padding: 12px 4px; border-bottom: 1px solid #f9fafb; align-items: center; }
        .btn-del-mini { color: #ccc; font-size: 10px; margin-left: 8px; cursor: pointer; }
        .btn-del-mini:hover { color: #ff9999; }

        .photo-upload-placeholder { aspect-ratio: 1 / 1.1; background-color: #ffffff; border: 1.5px dashed #e5e7eb; border-radius: 2.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; width: 100%; }
        .btn-delete-photo { position: absolute; top: 12px; right: 12px; width: 22px; height: 22px; background: rgba(0,0,0,0.3); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .photo-upload-placeholder:hover .btn-delete-photo { opacity: 1; }

        .category-chip { padding: 6px 18px; border-radius: 99px; font-size: 11px; font-weight: 600; background: white; border: 1px solid #e5e7eb; color: #4b5563; white-space: nowrap; }
        .category-chip.active { background-color: #a5f3fc; color: #0891b2; border-color: #67e8f9; }

        #sticker-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .sticker { position: absolute; cursor: move; pointer-events: auto; z-index: 100; user-select: none; }
        .sticker img { max-width: 80px; max-height: 80px; display: block; }
        
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="max-w-xl mx-auto min-h-screen border-x border-gray-50 shadow-sm relative">

    <header class="sticky top-0 bg-white/80 backdrop-blur-md z-50 px-6 pt-12 pb-6">
        <div class="flex justify-between items-end">
            <h1 class="text-xl font-black tracking-tight text-gray-900 uppercase">Daily Diary</h1>
            <nav class="flex space-x-6 text-sm font-medium">
                <button onclick="switchTab('monthly')" id="btn-monthly" class="nav-btn active">Monthly</button>
                <button onclick="switchTab('daily')" id="btn-daily" class="nav-btn">Daily</button>
                <button onclick="switchTab('records')" id="btn-records" class="nav-btn">Records</button>
                <button onclick="switchTab('finance')" id="btn-finance" class="nav-btn">Finance</button>
            </nav>
        </div>
    </header>

    <main class="p-6">
        <section id="view-monthly" class="active">
            <div class="mb-10 flex justify-between items-center px-1">
                <div class="flex items-center gap-6">
                    <button onclick="changeMonth(-1)" class="text-gray-300 text-xl font-light">&lt;</button>
                    <h2 id="calendar-title" class="text-lg font-bold text-slate-800 tracking-tight">2026. 03</h2>
                    <button onclick="changeMonth(1)" class="text-gray-300 text-xl font-light">&gt;</button>
                </div>
                <button onclick="document.getElementById('sticker-upload').click()" class="text-[10px] font-bold bg-[#f0f9ff] text-sky-200 border border-sky-50 px-5 py-2 rounded-full uppercase tracking-widest">Ïä§Ìã∞Ïª§ Ï∂îÍ∞Ä</button>
                <input type="file" id="sticker-upload" class="hidden" accept="image/*" onchange="addSticker(event)">
            </div>
            <div class="relative">
                <div id="calendar-container" class="calendar-grid rounded-2xl overflow-hidden relative shadow-sm"></div>
                <div id="sticker-layer"></div>
            </div>
        </section>

        <section id="view-daily">
            <div class="flex justify-center items-center mb-14 pb-4 border-b border-gray-100">
                <h2 id="daily-date-header" class="text-xs font-bold tracking-widest text-gray-400 uppercase">2026.03.09 Monday</h2>
            </div>
            <div class="grid grid-cols-2 gap-10 items-stretch">
                <div class="flex flex-col space-y-10">
                    <div class="highlight-box bg-[var(--point-blue)] p-8 rounded-[2rem] border border-blue-100 text-center">
                        <p class="text-[10px] font-bold uppercase tracking-widest text-blue-400 mb-4 text-left">Highlight</p>
                        <div style="color: var(--point-blue-text);" class="text-3xl mb-2 select-none">‚ùù</div>
                        <textarea id="daily-highlight" spellcheck="false" class="w-full bg-transparent text-center text-xs font-medium outline-none h-12 resize-none" placeholder="Ïò§ÎäòÏùò ÌïµÏã¨ Î¨∏Ïû•"></textarea>
                    </div>
                    <div class="diary-box flex flex-col relative">
                        <p class="text-[10px] font-bold uppercase tracking-widest mb-6" style="color: #b48a09;">Diary</p>
                        <div class="flex justify-center mb-8 relative">
                             <div id="daily-emoji" class="text-3xl h-12 w-12 flex items-center justify-center cursor-pointer" ondblclick="deleteEmoji()">ü§ç</div>
                             <div onclick="openEmojiPicker('daily-emoji')" class="w-6 h-6 bg-white border border-pink-100 rounded-full flex items-center justify-center text-[10px] text-pink-200 absolute -bottom-1 -right-1 cursor-pointer shadow-sm">+</div>
                        </div>
                        <textarea id="daily-content" spellcheck="false" class="diary-paper" placeholder="Ïò§Îäò Ïñ¥Îñ§ ÏùºÏù¥ ÏûàÏóàÎÇòÏöî?"></textarea>
                    </div>
                </div>
                <div class="flex flex-col space-y-10">
                    <div class="p-6 rounded-[2rem] bg-[var(--point-purple)] border border-purple-100">
                        <p class="text-[10px] font-bold uppercase tracking-widest text-purple-500 mb-4 text-left">Music</p>
                        <input type="text" id="yt-input" oninput="updateMusicPreview(this.value)" class="w-full bg-transparent border-b border-purple-100 text-[10px] italic outline-none pb-2 mb-4 text-gray-400" placeholder="YouTube Ï£ºÏÜå">
                        <div id="yt-preview" class="aspect-video bg-white/50 rounded-2xl flex items-center justify-center text-xl text-purple-300">üéµ</div>
                    </div>
                    <div class="border border-gray-100 rounded-[2rem] p-6 bg-white">
                        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-6">To-Do List</p>
                        <div id="todo-box" class="space-y-4"></div>
                        <button onclick="addNewTodo()" class="mt-6 text-[10px] font-bold text-gray-300 tracking-widest uppercase transition-colors">+ Add Task</button>
                    </div>
                    <div class="photo-upload-placeholder" onclick="document.getElementById('moment-upload').click()">
                        <img id="moment-preview" class="absolute inset-0 w-full h-full object-cover hidden" />
                        <div id="moment-placeholder" class="flex flex-col items-center">
                            <img src="https://img.icons8.com/material-outlined/48/cccccc/image--v1.png" class="w-7 h-7 opacity-40 mb-3" />
                            <span class="text-[9px] text-gray-300 font-bold uppercase tracking-widest">Add Photo</span>
                        </div>
                        <input type="file" id="moment-upload" class="hidden" accept="image/*" onchange="previewPhoto(event, 'moment-preview', 'moment-placeholder')">
                        <div onclick="deletePhoto(event, 'moment-preview', 'moment-placeholder', 'moment-upload')" class="btn-delete-photo">‚úï</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-records">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-gray-900">Archives</h2>
                <button onclick="toggleArchiveForm()" id="btn-toggle-archive" class="w-12 h-12 bg-gray-900 text-white rounded-full text-xl shadow-xl hover:scale-110 active:scale-95">+</button>
            </div>

            <div class="flex gap-2 overflow-x-auto pb-6 no-scrollbar" id="archive-filter-bar">
                <button class="category-chip active" onclick="filterArchives('ALL', this)">Ï†ÑÏ≤¥</button>
                <button class="category-chip" onclick="filterArchives('ÎßõÏßë', this)">ÎßõÏßë</button>
                <button class="category-chip" onclick="filterArchives('Ïπ¥Ìéò', this)">Ïπ¥Ìéò</button>
                <button class="category-chip" onclick="filterArchives('ÎØ∏ÎîîÏñ¥', this)">ÎØ∏ÎîîÏñ¥</button>
                <button class="category-chip" onclick="filterArchives('ÏÜåÏÑ§', this)">ÏÜåÏÑ§</button>
                <button class="category-chip" onclick="filterArchives('ÎßåÌôî', this)">ÎßåÌôî</button>
                <button class="category-chip" onclick="filterArchives('Í∏∞ÌÉÄ', this)">Í∏∞ÌÉÄ</button>
            </div>

            <div id="archive-form" class="hidden bg-white border border-pink-50 rounded-[3rem] p-10 mb-12 shadow-sm animate-in zoom-in-95">
                <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-4">1. Category</p>
                <div class="flex flex-wrap gap-2 mb-10" id="cat-selection">
                    <button class="category-chip active" onclick="selCat(this, 'ÎßõÏßë')">ÎßõÏßë</button>
                    <button class="category-chip" onclick="selCat(this, 'Ïπ¥Ìéò')">Ïπ¥Ìéò</button>
                    <button class="category-chip" onclick="selCat(this, 'ÎØ∏ÎîîÏñ¥')">ÎØ∏ÎîîÏñ¥</button>
                    <button class="category-chip" onclick="selCat(this, 'ÏÜåÏÑ§')">ÏÜåÏÑ§</button>
                    <button class="category-chip" onclick="selCat(this, 'ÎßåÌôî')">ÎßåÌôî</button>
                    <button class="category-chip" onclick="selCat(this, 'Í∏∞ÌÉÄ')">Í∏∞ÌÉÄ</button>
                </div>
                <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-4">2. Photo</p>
                <div class="photo-upload-placeholder mb-10" style="aspect-ratio: 16 / 9;" onclick="document.getElementById('archive-upload').click()">
                    <img id="archive-preview" class="absolute inset-0 w-full h-full object-cover hidden" />
                    <div id="archive-placeholder" class="flex flex-col items-center text-center">
                        <span class="text-xl mb-2">üì∑</span>
                        <span class="text-[10px] text-gray-300 font-bold uppercase tracking-widest px-4 leading-tight">Tap to add photo</span>
                    </div>
                    <input type="file" id="archive-upload" class="hidden" accept="image/*" onchange="previewPhoto(event, 'archive-preview', 'archive-placeholder')">
                    <div onclick="deletePhoto(event, 'archive-preview', 'archive-placeholder', 'archive-upload')" class="btn-delete-photo">‚úï</div>
                </div>
                <input type="text" id="archive-title" class="w-full font-bold text-xl mb-6 outline-none border-none placeholder:text-gray-200" placeholder="Ï†úÎ™©">
                <textarea id="archive-content" spellcheck="false" class="w-full text-sm outline-none h-40 resize-none leading-relaxed placeholder:text-gray-200" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."></textarea>
                <button onclick="saveArchive()" id="btn-archive-save" class="w-full py-5 bg-cyan-400 text-white rounded-full font-bold text-xs tracking-[0.2em] mt-6 shadow-lg shadow-cyan-100 uppercase">Save Record</button>
            </div>
            <div id="archive-list" class="space-y-4"></div>
        </section>

        <section id="view-finance">
            <div class="mb-10 flex justify-center items-center gap-6">
                <button onclick="changeFinanceMonth(-1)" class="text-gray-300 text-xl font-light">&lt;</button>
                <h2 id="finance-month-title" class="text-lg font-bold text-slate-800 tracking-tight">2026. 03</h2>
                <button onclick="changeFinanceMonth(1)" class="text-gray-300 text-xl font-light">&gt;</button>
            </div>
            
            <div class="bg-[var(--point-blue)] p-10 rounded-[3rem] border border-blue-50 mb-12 shadow-sm flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-bold text-sky-400 uppercase tracking-widest mb-3">Monthly Spending</p>
                    <h3 id="total-expense" class="text-3xl font-black text-sky-600 tracking-tight">‚Ç© 0</h3>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Total Realized Profit</p>
                    <h3 id="total-profit" class="text-2xl font-black text-red-400 tracking-tight">‚Ç© 0</h3>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-10 mb-12">
                <div>
                    <h4 class="text-[11px] font-black text-sky-500 uppercase tracking-widest mb-6 px-1">ÏßÄÏ∂ú Í∏∞Î°ù</h4>
                    <div class="bg-white border border-gray-100 rounded-[2.5rem] p-8 shadow-sm">
                        <input type="text" id="exp-name" class="w-full text-sm font-bold border-b border-gray-50 pb-3 mb-6 outline-none" placeholder="Ìï≠Î™©">
                        <input type="number" id="exp-amount" class="w-full text-sm font-bold border-b border-gray-50 pb-3 mb-8 outline-none" placeholder="Í∏àÏï° (‚Ç©)">
                        <button onclick="addExpense()" class="w-full py-4 bg-sky-400 text-white rounded-full font-bold text-[10px] tracking-widest uppercase shadow-md shadow-sky-100">Add Expense</button>
                    </div>
                </div>
                <div>
                    <h4 class="text-[11px] font-black text-sky-500 uppercase tracking-widest mb-6 px-1">Ïã§ÌòÑ ÏÜêÏùµ</h4>
                    <div class="bg-white border border-gray-100 rounded-[2.5rem] p-8 shadow-sm">
                        <input type="text" id="profit-name" class="w-full text-sm font-bold border-b border-gray-50 pb-3 mb-6 outline-none" placeholder="Ï¢ÖÎ™©Î™Ö">
                        <input type="number" id="profit-amount" class="w-full text-sm font-bold border-b border-gray-50 pb-3 mb-8 outline-none" placeholder="Ïã§ÌòÑÏÜêÏùµ (‚Ç©)">
                        <button onclick="addProfit()" class="w-full py-4 bg-sky-600 text-white rounded-full font-bold text-[10px] tracking-widest uppercase shadow-md shadow-sky-200">Record Profit</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-10">
                <div id="expense-list" class="space-y-1"></div>
                <div id="profit-list" class="space-y-1"></div>
            </div>
        </section>
    </main>

    <div id="archive-detail-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6" onclick="closeArchiveDetail()">
        <div class="bg-white rounded-[3rem] w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col shadow-2xl animate-in zoom-in-95" onclick="event.stopPropagation()">
            <div class="relative w-full bg-slate-50 flex-shrink-0">
                <img id="detail-img" src="" class="w-full max-h-80 object-cover">
                <button onclick="closeArchiveDetail()" class="absolute top-6 right-6 w-10 h-10 bg-black/20 hover:bg-black/40 backdrop-blur-md rounded-full text-white flex items-center justify-center">‚úï</button>
            </div>
            <div class="p-10 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <span id="detail-cat" class="text-[10px] font-bold text-cyan-400 bg-cyan-50 px-3 py-1 rounded-full uppercase">CATEGORY</span>
                    <span id="detail-date" class="text-[10px] text-gray-300 font-medium">DATE</span>
                </div>
                <h2 id="detail-title" class="text-2xl font-black text-gray-900 mb-6 tracking-tight">TITLE</h2>
                <p id="detail-content" class="text-sm text-gray-500 leading-relaxed whitespace-pre-wrap"></p>
                <div class="mt-10 flex gap-4 pt-6 border-t border-gray-50">
                    <button id="btn-edit-trigger" class="flex-1 py-4 bg-slate-50 text-slate-400 font-bold text-[10px] rounded-full uppercase">Edit</button>
                    <button id="btn-delete-trigger" class="flex-1 py-4 bg-red-50 text-red-300 font-bold text-[10px] rounded-full uppercase">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="emoji-modal" class="fixed inset-0 bg-black/5 backdrop-blur-md z-[100] hidden flex items-center justify-center">
        <div class="bg-white p-10 rounded-[3rem] max-w-sm w-full shadow-2xl">
            <div class="grid grid-cols-5 gap-6 h-80 overflow-y-auto pr-2" id="emoji-grid"></div>
            <button onclick="closeEmojiPicker()" class="w-full mt-8 py-4 bg-gray-50 text-gray-400 font-bold rounded-2xl text-[10px] uppercase">Close</button>
        </div>
    </div>

    <script>
        let currentYear = 2026, currentMonth = 2, selectedDate = "2026-03-09", curCat = 'ÎßõÏßë', editingId = null;
        let financeYear = 2026, financeMonth = 2;
        let diaryStore = JSON.parse(localStorage.getItem('diaryStore')) || {};
        let archiveStore = JSON.parse(localStorage.getItem('archiveStore')) || [];
        let financeStore = JSON.parse(localStorage.getItem('financeStore')) || {}; 
        let cellMemos = JSON.parse(localStorage.getItem('cellMemos')) || {}; 
        
        const emojis = ['üòÄ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü•π','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü´†','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','ü•±','üò¥','ü§§','üò™','üòµ','üòµ‚Äçüí´','‚òÄÔ∏è','‚òÅÔ∏è','üå•Ô∏è','üå¶Ô∏è','üåßÔ∏è','üå®Ô∏è','üå©Ô∏è','‚õàÔ∏è','üå´Ô∏è','‚òÉÔ∏è','üåô','üåü','‚≠ê','üî•','üíß','üåà','üçÄ','üå∏','ü©∑','üå∑','üåº','üå±','üóùÔ∏è','üçª','üß∏','üéÅ','üç•','‚úâÔ∏è','üì¶','üïØÔ∏è','üí°','üíª','üì±','üì∑','üé¨','üìö','üé®','üéß','üé∏','üéÆ','üèÄ','‚öΩÔ∏è','üö¥','üéæ','üç±','üç≤','üçô','ü•ü','üçï','üçî','ü•®','üç¶','üç∞','üç∑','‚òïÔ∏è','ü•§','üç∑','üç∫','‚ÄºÔ∏è','‚ÅâÔ∏è','‚ùì','‚ùó','‚≠ï','‚ùå','‚úÖ','‚ö†Ô∏è','üí§','üí¨','üí≠','ü§ç','üç£'];

        window.onload = () => { renderCalendar(); renderArchives(); renderFinance(); initEmojiPicker(); switchTab('monthly'); };

        function switchTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + id).classList.add('active');
            if(id === 'daily') loadDaily(selectedDate);
            window.scrollTo(0,0);
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-container'); container.innerHTML = '';
            const labels = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
            labels.forEach(d => {
                const h = document.createElement('div'); h.className = "text-[9px] text-center py-4 font-bold bg-white";
                h.style.borderRight = "1.5px solid var(--border-color)"; h.style.borderBottom = "1.5px solid var(--border-color)";
                if(d==='SAT') h.classList.add('text-blue-400'); else if(d==='SUN') h.classList.add('text-red-400'); else h.classList.add('text-slate-400');
                h.innerText = d; container.appendChild(h);
            });
            document.getElementById('calendar-title').innerText = `${currentYear}. ${String(currentMonth+1).padStart(2,'0')}`;
            const firstDay = (new Date(currentYear, currentMonth, 1).getDay() || 7) - 1;
            for(let i=0; i<firstDay; i++) {
                const empty = document.createElement('div'); empty.style.borderRight = "1.5px solid var(--border-color)"; empty.style.borderBottom = "1.5px solid var(--border-color)";
                container.appendChild(empty);
            }
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
            for(let i=1; i<=lastDate; i++) {
                const key = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const cell = document.createElement('div'); cell.className = `calendar-cell cursor-pointer transition-all hover:bg-white`;
                cell.innerHTML = `<span class="text-[9px] font-bold ${new Date(currentYear,currentMonth,i).getDay()===0?'text-red-300':''}">${i}</span><div class="text-center text-xs my-auto pointer-events-none">${diaryStore[key]?.emoji || ''}</div><textarea spellcheck="false" class="cell-memo" placeholder="Î©îÎ™®" oninput="saveCellMemo('${key}', this.value)" onclick="event.stopPropagation()">${cellMemos[key] || ''}</textarea>`;
                cell.onclick = (e) => { if(e.target.tagName !== 'TEXTAREA') { selectedDate = key; document.getElementById('daily-date-header').innerText = key; switchTab('daily'); renderCalendar(); } };
                container.appendChild(cell);
            }
        }
        function saveCellMemo(k, v) { cellMemos[k] = v; localStorage.setItem('cellMemos', JSON.stringify(cellMemos)); }

        function addSticker(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const stickerLayer = document.getElementById('sticker-layer');
                    const stickerDiv = document.createElement('div');
                    stickerDiv.className = 'sticker';
                    stickerDiv.style.left = '50px'; stickerDiv.style.top = '100px';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    stickerDiv.appendChild(img);
                    stickerDiv.ondblclick = (ev) => { ev.stopPropagation(); stickerDiv.remove(); };
                    let isDragging = false; let startX, startY;
                    stickerDiv.onmousedown = (ev) => { isDragging = true; startX = ev.clientX - stickerDiv.offsetLeft; startY = ev.clientY - stickerDiv.offsetTop; stickerDiv.style.zIndex = 1000; };
                    document.onmousemove = (ev) => { if (!isDragging) return; stickerDiv.style.left = (ev.clientX - startX) + 'px'; stickerDiv.style.top = (ev.clientY - startY) + 'px'; };
                    document.onmouseup = () => { isDragging = false; };
                    stickerLayer.appendChild(stickerDiv);
                }
                reader.readAsDataURL(file);
                event.target.value = '';
            }
        }

        function saveArchive() {
            const t = document.getElementById('archive-title').value, c = document.getElementById('archive-content').value;
            const img = document.getElementById('archive-preview'); if(!t) return alert('Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
            const entry = { id: editingId || Date.now(), title: t, content: c, cat: curCat, photo: img.classList.contains('hidden') ? '' : img.src, date: new Date().toLocaleDateString() };
            if(editingId) { const idx = archiveStore.findIndex(a => a.id === editingId); archiveStore[idx] = entry; editingId = null; }
            else { archiveStore.push(entry); }
            localStorage.setItem('archiveStore', JSON.stringify(archiveStore));
            clearArchiveForm(); toggleArchiveForm(); renderArchives();
        }
        function renderArchives(filter = 'ALL') {
            const b = document.getElementById('archive-list'); b.innerHTML = '';
            const list = filter === 'ALL' ? archiveStore : archiveStore.filter(a => a.cat === filter);
            list.forEach(a => {
                const d = document.createElement('div'); d.className = "archive-list-item";
                d.onclick = () => showArchiveDetail(a);
                d.innerHTML = `<div class="w-16 h-16 rounded-2xl bg-gray-50 flex-shrink-0 overflow-hidden">${a.photo ? `<img src="${a.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-gray-200 text-xs">Pic</div>`}</div><div class="flex-grow"><div class="flex justify-between items-start mb-1"><span class="text-[9px] font-bold text-cyan-400 bg-cyan-50 px-2 py-0.5 rounded-full uppercase">${a.cat}</span><span class="text-[9px] text-gray-300 font-medium">${a.date}</span></div><h3 class="font-bold text-sm text-gray-800">${a.title}</h3><p class="text-[10px] text-gray-400 mt-1 line-clamp-1">${a.content}</p></div>`;
                b.prepend(d);
            });
        }
        function showArchiveDetail(a) {
            document.getElementById('detail-cat').innerText = a.cat; document.getElementById('detail-date').innerText = a.date;
            document.getElementById('detail-title').innerText = a.title; document.getElementById('detail-content').innerText = a.content;
            const img = document.getElementById('detail-img'); if(a.photo) { img.src = a.photo; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
            document.getElementById('btn-edit-trigger').onclick = () => editArchive(a);
            document.getElementById('btn-delete-trigger').onclick = () => deleteArchive(a.id);
            document.getElementById('archive-detail-modal').classList.remove('hidden');
        }
        function closeArchiveDetail() { document.getElementById('archive-detail-modal').classList.add('hidden'); }
        function deleteArchive(id) { if(confirm('Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?')) { archiveStore = archiveStore.filter(a => a.id !== id); localStorage.setItem('archiveStore', JSON.stringify(archiveStore)); closeArchiveDetail(); renderArchives(); } }
        function filterArchives(cat, btn) { document.querySelectorAll('#archive-filter-bar .category-chip').forEach(c => c.classList.remove('active')); btn.classList.add('active'); renderArchives(cat); }
        function clearArchiveForm() { document.getElementById('archive-title').value = ''; document.getElementById('archive-content').value = ''; document.getElementById('archive-preview').classList.add('hidden'); document.getElementById('archive-placeholder').classList.remove('hidden'); editingId = null; document.getElementById('btn-archive-save').innerText = 'SAVE RECORD'; }

        function changeFinanceMonth(s) { financeMonth += s; if(financeMonth>11){financeMonth=0;financeYear++}else if(financeMonth<0){financeMonth=11;financeYear--} renderFinance(); }
        function addExpense() {
            const n = document.getElementById('exp-name').value, a = document.getElementById('exp-amount').value; if(!n || !a) return alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
            const key = `${financeYear}-${financeMonth}`; if(!financeStore[key]) financeStore[key] = { expenses: [], profits: [] };
            financeStore[key].expenses.push({ id: Date.now(), name: n, amount: Number(a) }); localStorage.setItem('financeStore', JSON.stringify(financeStore));
            document.getElementById('exp-name').value = ''; document.getElementById('exp-amount').value = ''; renderFinance();
        }
        function addProfit() {
            const n = document.getElementById('profit-name').value, a = document.getElementById('profit-amount').value; if(!n || !a) return alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
            const key = `${financeYear}-${financeMonth}`; if(!financeStore[key]) financeStore[key] = { expenses: [], profits: [] };
            financeStore[key].profits.push({ id: Date.now(), name: n, amount: Number(a) }); localStorage.setItem('financeStore', JSON.stringify(financeStore));
            document.getElementById('profit-name').value = ''; document.getElementById('profit-amount').value = ''; renderFinance();
        }
        function deleteFinanceItem(type, id) { const key = `${financeYear}-${financeMonth}`; financeStore[key][type] = financeStore[key][type].filter(i => i.id !== id); localStorage.setItem('financeStore', JSON.stringify(financeStore)); renderFinance(); }
        function renderFinance() {
            document.getElementById('finance-month-title').innerText = `${financeYear}. ${String(financeMonth+1).padStart(2,'0')}`;
            const key = `${financeYear}-${financeMonth}`; const data = financeStore[key] || { expenses: [], profits: [] };
            const exList = document.getElementById('expense-list'); exList.innerHTML = '';
            let totalEx = 0; data.expenses.forEach(e => { totalEx += e.amount; const d = document.createElement('div'); d.className = "finance-item"; d.innerHTML = `<span>${e.name}</span><span class="text-sky-600 font-bold">‚Ç© ${e.amount.toLocaleString()}<i class="btn-del-mini" onclick="deleteFinanceItem('expenses', ${e.id})">‚úï</i></span>`; exList.prepend(d); });
            document.getElementById('total-expense').innerText = `‚Ç© ${totalEx.toLocaleString()}`;
            const prList = document.getElementById('profit-list'); prList.innerHTML = '';
            let totalPr = 0; data.profits.forEach(p => { totalPr += p.amount; const d = document.createElement('div'); d.className = "finance-item"; d.innerHTML = `<span>${p.name}</span><span class="${p.amount >= 0 ? 'text-red-500' : 'text-blue-500'} font-bold">${p.amount >= 0 ? '+' : ''}${p.amount.toLocaleString()}Ïõê<i class="btn-del-mini" onclick="deleteFinanceItem('profits', ${p.id})">‚úï</i></span>`; prList.prepend(d); });
            const prEl = document.getElementById('total-profit'); prEl.innerText = `‚Ç© ${totalPr.toLocaleString()}`; prEl.className = totalPr >= 0 ? "text-2xl font-black text-red-400" : "text-2xl font-black text-blue-400";
        }

        function loadDaily(key) {
            const d = diaryStore[key] || { highlight:'', content:'', emoji:'ü§ç', youtube:'', todos:[], moment:'' };
            document.getElementById('daily-highlight').value = d.highlight; document.getElementById('daily-content').value = d.content;
            document.getElementById('daily-emoji').innerText = d.emoji || 'ü§ç'; document.getElementById('yt-input').value = d.youtube;
            updateMusicPreview(d.youtube); const box = document.getElementById('todo-box'); box.innerHTML = '';
            (d.todos || []).forEach(t => addTodoRow(t.text, t.done)); if(!d.todos?.length) addNewTodo();
            const img = document.getElementById('moment-preview'), place = document.getElementById('moment-placeholder');
            if(d.moment) { img.src = d.moment; img.classList.remove('hidden'); place.classList.add('hidden'); }
            else { img.classList.add('hidden'); place.classList.remove('hidden'); }
        }
        function saveDailyData() {
            const todos = []; document.querySelectorAll('.todo-item').forEach(r => {
                const txt = r.querySelector('input[type="text"]').value; const chk = r.querySelector('input[type="checkbox"]').checked;
                if(txt) todos.push({ text: txt, done: chk });
            });
            diaryStore[selectedDate] = {
                highlight: document.getElementById('daily-highlight').value, content: document.getElementById('daily-content').value,
                emoji: document.getElementById('daily-emoji').innerText, youtube: document.getElementById('yt-input').value,
                todos: todos, moment: document.getElementById('moment-preview').src.startsWith('data') ? document.getElementById('moment-preview').src : (diaryStore[selectedDate]?.moment || '')
            };
            localStorage.setItem('diaryStore', JSON.stringify(diaryStore)); renderCalendar();
        }
        function deletePhoto(ev, pId, hId, iId) { ev.stopPropagation(); const i = document.getElementById(pId), h = document.getElementById(hId); i.src = ''; i.classList.add('hidden'); h.classList.remove('hidden'); document.getElementById(iId).value=''; if(pId==='moment-preview') saveDailyData(); }
        function previewPhoto(ev, pId, hId) { const f = ev.target.files[0]; if(f) { const r = new FileReader(); r.onload = (e) => { const i = document.getElementById(pId), h = document.getElementById(hId); i.src = e.target.result; i.classList.remove('hidden'); h.classList.add('hidden'); if(pId==='moment-preview') saveDailyData(); }; r.readAsDataURL(f); } }
        function updateMusicPreview(u) { const id = (u.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|shorts\/)([^#\&\?]*).*/)?.[2] || null); document.getElementById('yt-preview').innerHTML = id ? `<iframe class="w-full h-full rounded-2xl" src="https://www.youtube.com/embed/${id}"></iframe>` : 'üéµ'; }
        function initEmojiPicker() { const g = document.getElementById('emoji-grid'); emojis.forEach(e => { const d = document.createElement('div'); d.className = "text-2xl cursor-pointer text-center p-3 hover:bg-gray-50 rounded-3xl"; d.innerText = e; d.onclick = () => { if(currentTargetId) { document.getElementById(currentTargetId).innerText = e; saveDailyData(); } closeEmojiPicker(); }; g.appendChild(d); }); }
        let currentTargetId = ''; function openEmojiPicker(id) { currentTargetId = id; document.getElementById('emoji-modal').classList.remove('hidden'); }
        function closeEmojiPicker() { document.getElementById('emoji-modal').classList.add('hidden'); }
        function deleteEmoji() { document.getElementById('daily-emoji').innerText = ''; saveDailyData(); }
        function addNewTodo() { addTodoRow('', false); }
        function addTodoRow(t, d) { const div = document.createElement('div'); div.className = "todo-item flex items-center space-x-4"; div.innerHTML = `<input type="checkbox" ${d?'checked':''} onchange="saveDailyData()" class="w-4 h-4 rounded-full border-gray-100 accent-gray-900 shadow-sm"><input type="text" class="w-full bg-transparent text-[11px] outline-none text-gray-400 font-medium" value="${t}" placeholder="Ìï† Ïùº..." oninput="saveDailyData()">`; document.getElementById('todo-box').appendChild(div); }
        function selCat(btn, c) { document.querySelectorAll('#cat-selection .category-chip').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); curCat = c; }
        function toggleArchiveForm() { document.getElementById('archive-form').classList.toggle('hidden'); editingId = null; }
        function changeMonth(s) { currentMonth += s; if(currentMonth>11){currentMonth=0;currentYear++}else if(currentMonth<0){currentMonth=11;currentYear--} renderCalendar(); }
    </script>
</body>
</html>
